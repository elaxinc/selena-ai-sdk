#!/usr/bin/env node

import { Command } from 'commander';
import inquirer from 'inquirer';
import chalk from 'chalk';
import readline from 'readline';
import { SelenaAI } from '../src/index.js';

const program = new Command();

program
  .name('selena')
  .description('CLI interativo para Selena AI')
  .version('1.0.0');

program
  .command('chat')
  .description('Iniciar conversa interativa')
  .option('-v, --verbose', 'Mostrar logs detalhados')
  .option('-q, --quiet', 'Desativar logs')
  .option('-s, --stream', 'Habilitar streaming de resposta (mostra resposta em tempo real)')
  .action(async (options) => {
    const apiKey = process.env.SELENA_API_KEY;
    if (!apiKey) {
      console.error(chalk.red('‚ùå Erro: SELENA_API_KEY n√£o encontrada'));
      console.error(chalk.yellow('üí° Defina a vari√°vel de ambiente:'));
      console.error(chalk.gray('   export SELENA_API_KEY=sua_chave_aqui'));
      console.error(chalk.gray('   Ou configure no seu shell (.bashrc, .zshrc, etc)'));
      process.exit(1);
    }
    
    try {
      const client = new SelenaAI({
        apiKey,
        logging: options.verbose ? 'debug' : options.quiet ? 'none' : 'info'
      });
      
      console.log(chalk.green('ü§ñ Selena AI - Modo Interativo'));
      console.log(chalk.gray('Digite "sair" para encerrar a conversa'));
      console.log(chalk.gray('Digite "limpar" para limpar a tela\n'));
      
      const rl = readline.createInterface({
        input: process.stdin,
        output: process.stdout
      });
      
      while (true) {
        const question = await new Promise(resolve => {
          rl.question(chalk.blue('‚ú® Voc√™: '), resolve);
        });
        
        // Comandos especiais
        const input = question.trim().toLowerCase();
        
        if (input === 'sair' || input === 'exit') {
          console.log(chalk.yellow('\nüëã At√© logo!'));
          break;
        }
        
        if (input === 'limpar' || input === 'clear') {
          console.clear();
          console.log(chalk.green('ü§ñ Selena AI - Modo Interativo'));
          console.log(chalk.gray('Digite "sair" para encerrar a conversa\n'));
          continue;
        }
        
        if (input === 'help') {
          console.log(chalk.cyan('\nüìñ Comandos dispon√≠veis:'));
          console.log(chalk.gray('  sair, exit   - Encerrar o chat'));
          console.log(chalk.gray('  limpar, clear - Limpar a tela'));
          console.log(chalk.gray('  help         - Mostrar esta ajuda\n'));
          continue;
        }
        
        if (!question.trim()) {
          console.log(chalk.yellow('‚ö†Ô∏è  Por favor, digite uma mensagem\n'));
          continue;
        }
        
        try {
          process.stdout.write(chalk.green('üß† Selena: '));
          
          if (options.stream) {
            // Modo streaming com efeito de digita√ß√£o
            console.log(); // Quebra de linha antes do streaming
            await client.chat.completions({
              model: 'selena-pro-v1',
              message: question,
              stream: true,
              onToken: (token) => {
                // Processa cada caractere com delay para simular digita√ß√£o
                for (const char of token) {
                  process.stdout.write(char);
                  // Delay aleat√≥rio entre 10-50ms para parecer mais natural
                  const delay = Math.random() * 40 + 10;
                  Atomics.wait(new Int32Array(new SharedArrayBuffer(4)), 0, 0, delay);
                }
              }
            });
            console.log(); // Nova linha ao final
          } else {
            // Modo normal
            const response = await client.chat.completions({
              model: 'selena-pro-v1',
              message: question
            });
            
            console.log(response.response || response.text || 'Sem resposta');
            console.log();
          }
        } catch (error) {
          console.error(chalk.red('‚ùå Erro:'), error.message);
          console.log();
        }
      }
      
      rl.close();
    } catch (error) {
      console.error(chalk.red('‚ùå Erro ao inicializar:'), error.message);
      process.exit(1);
    }
  });

program
  .command('ask <message>')
  .description('Fazer uma √∫nica pergunta √† Selena AI')
  .option('-v, --verbose', 'Mostrar logs detalhados')
  .option('-q, --quiet', 'Desativar logs')
  .option('-s, --stream', 'Habilitar streaming de resposta (mostra resposta em tempo real)')
  .action(async (message, options) => {
    const apiKey = process.env.SELENA_API_KEY;
    if (!apiKey) {
      console.error(chalk.red('‚ùå Erro: SELENA_API_KEY n√£o encontrada'));
      console.error(chalk.yellow('üí° Defina a vari√°vel de ambiente: export SELENA_API_KEY=sua_chave'));
      process.exit(1);
    }
    
    if (!message) {
      console.error(chalk.red('‚ùå Erro: Voc√™ precisa fornecer uma mensagem'));
      console.error(chalk.gray('Exemplo: selena ask "Qual a capital da Fran√ßa?"'));
      process.exit(1);
    }
    
    try {
      const client = new SelenaAI({
        apiKey,
        logging: options.verbose ? 'debug' : options.quiet ? 'none' : 'none'
      });
      
      process.stdout.write(chalk.green('üß† Selena: '));
      
        if (options.stream) {
          // Modo streaming com efeito de digita√ß√£o
          console.log(); // Quebra de linha antes do streaming
          await client.chat.completions({
            model: 'selena-pro-v1',
            message,
            stream: true,
            onToken: (token) => {
              // Processa cada caractere com delay para simular digita√ß√£o
              for (const char of token) {
                process.stdout.write(char);
                // Delay aleat√≥rio entre 10-50ms para parecer mais natural
                const delay = Math.random() * 40 + 10;
                Atomics.wait(new Int32Array(new SharedArrayBuffer(4)), 0, 0, delay);
              }
            }
          });
          console.log(); // Nova linha ao final
      } else {
        // Modo normal
        const response = await client.chat.completions({
          model: 'selena-pro-v1',
          message
        });
        
        console.log(response.response || response.text || 'Sem resposta');
      }
    } catch (error) {
      console.error(chalk.red('‚ùå Erro:'), error.message);
      process.exit(1);
    }
  });

program
  .command('config')
  .description('Configurar API key')
  .action(async () => {
    console.log(chalk.cyan('‚öôÔ∏è  Configura√ß√£o da Selena AI'));
    console.log(chalk.gray('Para configurar sua API key:'));
    console.log(chalk.yellow('1. Acesse: https://elaxi.xyz/dashboard'));
    console.log(chalk.yellow('2. Copie sua API key'));
    console.log(chalk.yellow('3. Execute no terminal:'));
    console.log(chalk.white('   export SELENA_API_KEY=sua_chave_aqui'));
    console.log(chalk.gray('\nPara tornar permanente, adicione ao seu ~/.bashrc ou ~/.zshrc'));
  });

// Handle unknown commands
program.on('command:*', () => {
  console.error(chalk.red('‚ùå Comando desconhecido'));
  console.log(chalk.yellow('Use "selena --help" para ver os comandos dispon√≠veis'));
  process.exit(1);
});

// Parse command line arguments
program.parse();

// Show help if no command provided
if (!process.argv.slice(2).length) {
  program.outputHelp();
}